{% extends "layout.html" %}
{% block content %}
<div class="container mt-4">
  <div class="card shadow rounded-4">
    <div class="card-header bg-dark text-white">
      <h4 class="mb-0">üóÇÔ∏è Upload Full Case Package for Analysis</h4>
    </div>
    <div class="card-body">
      <form id="caseUploadForm" action="/case-strategy/process" method="post" enctype="multipart/form-data">
        <div class="mb-3">
          <label for="fileUpload" class="form-label fw-bold">Select multiple documents (PDF or DOCX):</label>
          <input class="form-control" type="file" id="fileUpload" name="files" accept=".pdf,.docx" multiple required>
          <div class="form-text text-muted">Use <kbd>Ctrl</kbd> / <kbd>Cmd</kbd> to select multiple files.</div>
        </div>
        <button type="submit" class="btn btn-primary w-100 mt-3" id="analyzeBtn">
          üîç Analyze Case
        </button>
        <div id="processingIndicator" class="text-center mt-3" style="display: none;">
          <div class="spinner-border text-primary" role="status"></div>
          <p class="fw-semibold mt-2">Analyzing uploaded documents... Please wait.</p>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.getElementById('caseUploadForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const btn  = document.getElementById('analyzeBtn');
  const indi = document.getElementById('processingIndicator');
  btn.disabled = true; btn.innerText = 'Uploading‚Ä¶'; indi.style.display = 'block';

  const fd = new FormData(e.target);
  const r  = await fetch('/case-strategy/process', {method:'POST', body:fd});
  const {task_id, case_id} = await r.json();

  // poll every 2 s until Celery is done
  async function poll() {
    const res   = await fetch(`/case-strategy/result/${task_id}`);
    const json  = await res.json();
    if (json.state) { setTimeout(poll, 2000); return; }   // not ready
    // redirect to result page with data stuffed into session-storage
    sessionStorage.setItem('caseResult', JSON.stringify(json));
    window.location = `/case-strategy/result-page.html`;
  }
  poll();
});
</script>

{% endblock %}
